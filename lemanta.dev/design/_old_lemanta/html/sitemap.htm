{* <!-- ===========================================================================
                                                                                  |
    Страница: Карта сайта.                                                        |
    ----------------------------------------------------------------------------  |
                                                                                  |
    Входные переменные:                                                           |
        $section = запись о текущей странице (если создана в списке специальных   |
                   страниц и вызвана по своему URL, а не через системный URL или  |
                   неучтенный случай "Ошибка 404")                                |
        $categories = дерево записей о категориях                                 |
        $all_brands = дерево записей о брендах                                    |
                                                                                  |
============================================================================ --> *}{strip}

    {* <!-- =======================================================================
    |                                                                             |
    |  Объявляем локальную функцию sitemapBlock = вывод блока записей.            |
    |                                                                             |
    ======================================================================== --> *}

    {function sitemapBlock title=''}
        {if !empty($items)}
            {function sitemapListing}
                <ul>
                    {foreach $items as $item}
                        {if !empty($item->enabled) && (empty($item->hidden) || !empty($user->user_id))}
                            <li>
                                <a href="{url}">{name}</a>
                                {if !empty($item->subcategories)}
                                    {sitemapListing items=$item->subcategories}
                                {elseif !empty($item->subbrands)}
                                    {sitemapListing items=$item->subbrands}
                                {/if}
                            </li>
                        {/if}
                    {/foreach}
                </ul>
            {/function}
            {sitemapListing}
        {/if}
    {/function}

    {* <!-- =======================================================================
    |                                                                             |
    |  Хлебные крошки.                                                            |
    |                                                                             |
    ======================================================================== --> *}

    {$mod = 'mod-breadcrumbs.htm'}
    {if $emulator->existsModule($mod)}
        {include "$mod"
                  title = 'Карта сайта'
                  noCatalogLink = TRUE}
    {/if}

    {* <!-- =======================================================================
    |                                                                             |
    |  Листинг категорий.                                                         |
    |                                                                             |
    ======================================================================== --> *}

    {if !isset($categories)}
        {categories assign=categories scope=global}
    {/if}

    <div class="right">
        <div class="left-column">
            <div class="sitemap">
                <h2>Разделы сайта</h2>
                {sitemapBlock items=$categories}
            </div>

            {* <!-- ===============================================================
            |                                                                     |
            |  Листинг статей.                                                    |
            |                                                                     |
            ================================================================ --> *}

            {articles count=250 assign=articles}

            {if !empty($articles)}
                <div class="sitemap">
                    <h2>Статьи</h2>
                    {sitemapBlock items=$articles}
                </div>
            {/if}
        </div>

        {* <!-- ===================================================================
        |                                                                         |
        |  Листинг брендов.                                                       |
        |                                                                         |
        ==================================================================== --> *}

        {if !isset($all_brands)}
            {categories table=brands assign=all_brands scope=global}
        {/if}

        <div class="right-column">
            {if !empty($all_brands)}
                <div class="sitemap">
                    <h2>Производители</h2>
                    {sitemapBlock items=$all_brands}
                </div>
            {/if}

            {* <!-- ===============================================================
            |                                                                     |
            |  Листинг новостей.                                                  |
            |                                                                     |
            ================================================================ --> *}

            {news count=250 assign=news}

            {if !empty($news)}
                <div class="sitemap">
                    <h2>Новости</h2>
                    {sitemapBlock items=$news}
                </div>
            {/if}
        </div>
    </div>

    {* <!-- =======================================================================
    |                                                                             |
    |  SEO тонкости: Если страница вызвана по системному URL (то есть менеджеру   |
    |  плевать на редиректы со страниц-зеркал на основные), страхуем его ошибки - |
    |  устанавливаем глобальные переменные (для заголовков страницы в index.tpl)  |
    |  с некими дефолтными значениями для такого случая.                          |
    |                                                                             |
    ======================================================================== --> *}

    {if !empty($section)}
        {$title = 'Карта сайта' scope=global}
        {$description = '' scope=global}
        {$keywords = '' scope=global}
    {/if}

{/strip}